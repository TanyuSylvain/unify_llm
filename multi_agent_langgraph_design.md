# 基于LangGraph的多智能体协作系统设计方案

## 一、系统概述

本系统采用"主持人—专家—批判者"三角色架构，通过LangGraph框架实现多智能体协作与辩论。系统工作流程为：主持人分析用户问题并分发给专家，专家生成初始答案，批判者评审并提出修改建议，经多轮迭代后由主持人生成最终答案。该设计借鉴人类协作决策机制，通过"生成—批判—修正"闭环提升答案质量。

## 二、核心架构设计

### 2.1 角色职责定义

**主持人智能体**：作为系统核心枢纽，承担意图识别、任务分发、流程控制和质量把关职责。主持人需要评估问题复杂度以决定是否启动完整协作流程，审查专家与批判者的输出内容确保讨论围绕用户问题展开，并在适当时机终止迭代生成最终答案。

**专家智能体**：负责根据用户问题生成专业、深入的答案。专家应当具备领域知识深度和创造性表达能力，能够理解批判意见并进行针对性修改，同时保持答案的核心价值不被动摇。

**批判者智能体**：负责对专家答案进行全面评审并指出待优化项。批判者需要检查逻辑完整性、事实准确性、信息全面性和表述清晰度，输出包含评分、问题列表和修改建议的结构化评审报告，所有批评必须引用原文作为依据。

### 2.2 三角色交互关系

主持人位于交互中心，分别与专家和批判者建立双向通信通道。专家专注于答案生成，不直接与批判者对话。批判者仅接收答案进行评审，不参与答案修改。主持人聚合各方输出，进行决策判断，控制流程走向。这种层级化设计便于状态管理和流程调试。

## 三、LangGraph技术选型

### 3.1 选型依据

本系统选用LangGraph作为底层编排框架，主要基于以下考量。LangGraph采用图结构定义智能体交互，节点代表各角色智能体，边代表交互关系，条件边支持根据状态动态跳转，完美契合本系统的循环工作流特征。LangGraph与LangChain生态深度集成，便于接入多种模型和工具。状态管理机制清晰，每个节点可访问和修改全局状态，便于实现复杂的流程控制逻辑。

### 3.2 LangGraph核心概念映射

在本系统设计中，节点（Node）对应三个智能体角色，分别是moderator_node、expert_node和critic_node。边（Edge）定义角色间的交互关系，expert_to_moderator表示专家提交答案，critic_to_moderator表示批判者提交评审，moderator_to_expert表示主持人下达修改指令。条件边（Conditional Edge）实现流程分支判断，moderator_decide函数根据评审结果决定进入下一轮修改还是终止流程。状态（State）存储系统运行数据，包含当前问题、历史答案、评审记录、迭代轮次等信息。

### 3.3 图结构设计

系统图结构包含四个主要节点。moderator_init节点负责问题解析和任务分发，是流程入口。expert_generate节点负责答案生成，接收主持人指令后输出答案。critic_review节点负责答案评审，接收答案后输出结构化评审报告。moderator_synthesize节点负责最终整合，当满足终止条件时生成最终答案。

流程走向为：用户输入首先进入moderator_init，解析后转到expert_generate生成答案，答案提交后转到critic_review进行评审，评审结果返回moderator_synthesize进行判断。若评审通过或达到最大轮次，则输出最终答案；否则总结修改意见后返回expert_generate进入下一轮迭代。

## 四、工作流程详解

### 4.1 单轮迭代流程

第一阶段为问题分发，主持人接收用户问题，进行意图识别和复杂度评估。对于简单问题，主持人可跳过协作流程直接回答；对于复杂问题，主持人提取关键约束条件，构造结构化指令，分发给专家智能体。

第二阶段为答案生成，专家接收主持人指令，结合内部知识和外部工具生成答案。专家答案需包含问题理解、核心观点、详细论证、结论总结和置信度评估。完成后提交给主持人。当收到批判者的修改意见时，专家不应采取防御性态度，而应客观分析批评的合理性，针对性地优化答案内容。确保每次迭代都是有针对性的优化而非简单的重写。

第三阶段为评审，主持人将问题和答案转发给批判者。批判者从逻辑、事实、完整性、相关性四个维度进行评审，输出包含评分、状态、问题列表和修改建议的JSON格式报告。在逻辑审查方面，批判者需要检查专家答案的推理过程是否存在跳跃或漏洞。在事实核查方面，批判者需要验证专家答案中的事实性陈述是否准确。在完整性评估方面，批判者需要判断专家答案是否充分回应了用户问题的所有方面。在优化建议生成方面，批判者不应止于指出问题，还应提供具体、可操作的改进建议。

第四阶段为决策，主持人解析评审结果。若状态为通过或达到最大轮次，则进入答案整合阶段；否则总结修改意见，返回专家进入下一轮。主持人应当检查专家回答是否偏离主题、批判意见是否具有建设性、各方的论证逻辑是否自洽。一旦发现讨论偏离轨道，主持人应当及时干预，引导各方回归核心议题。

### 4.2 终止策略

系统采用双重终止策略。硬性限制方面，设置最大迭代轮次为3至5轮，达到限制后强制输出当前版本。软性判断方面，当连续两轮答案相似度超过0.95、批判者提出的新问题数量逐轮递减、或当前评分已满足预设阈值时，主持人可主动选择终止。当满足终止条件时，主持人应当整合各轮讨论的精华内容，生成结构化的最终答案。

## 五、关键技术要点

### 5.1 结构化通信协议

智能体间通信采用JSON结构化格式。专家答案格式包含版本号、理解概述、核心观点、详细内容、结论、置信度、局限性和修改记录。批判者评审格式包含评审版本、总体评分、通过状态、问题列表、优势总结、修改建议和信心指数。

### 5.2 记忆管理策略

采用滑动窗口和摘要压缩机制控制上下文长度。每轮迭代结束后，主持人对当轮对话进行摘要，只保留当前最优答案、最新批判意见和原始问题，避免上下文无限增长。

## 六、风险与对策

### 6.1 上下文膨胀

多轮迭代导致上下文长度快速增长，增加成本并分散模型注意力。对策包括信息压缩、选择性保留和窗口滑动。

### 6.2 目标漂移

讨论焦点可能逐渐偏离用户原始问题。对策为主持人在每轮执行相关性检查，在提示词中强化原始问题约束，如"请专家仅针对以下问题进行回答"。

### 6.3 幻觉批评

批判者可能指出不存在的问题。对策为在批判者提示词中要求引用原文作为批评依据，主持人进行二次审核验证批评合理性。

## 七、总结

本方案基于LangGraph框架设计了三角色智能体协作系统。LangGraph的图结构模型天然适配"生成—批判—修正"的循环工作流，状态管理机制便于实现复杂的流程控制。通过结构化通信协议、记忆管理策略和多重终止策略，系统能够在保证答案质量的同时控制成本和风险。后续可从动态专家选择、外部工具集成、人类介入机制等方向持续优化。
